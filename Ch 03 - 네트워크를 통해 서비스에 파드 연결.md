
# 쿠버네티스 내부의 네트워크 트래픽 라우팅

*1)* **문제점**
> 파드는 사용하고 버리는 리소스
> + 새로운 파드로 교체 시 → IP주소가 변경
> + IP 주소는 쿠버네티스API를 통해서 파악 가능하다.

Cmd **파드 간 통신**
*ref.* [[쿠버네티스-Ch1.pdf#page=81]]

*1)* **해결 - 서비스 도입** 
>+ 쿠버네티스 클러스터 전용 DNS 서버 존재
>+ 파드에 해당하는 **서비스**가 생성되고, 서비스의 IP주소가 DNS 서버에 등록된다.
>+ 레이블 셀렉터를 통한 서비스 - 파드 연결

Cmd **파드 간 통신**
*ref.* [[쿠버네티스-Ch1.pdf#page=83]]

![[서비스를 통한 파드간 통신.png]]
## 서비스

**이해**
> **디플로이먼트** :: 파드와 파드가 포함하는 컨테이너 추상화
> **서비스** :: 파드와 파드가 가진 네트워크 주소를 추상화

Cmd **서비스 정의 `yaml`**
*ref.* [[쿠버네티스-Ch1.pdf#page=83]]
```
apiVersion: v1   # 서비스는 v1 API 사용
kind: Service

metadata:
  name: sleep-2  # 서비스 이름이 도메인 네임으로 사용된다.

# 서비스 정의에는 셀렉터와 포트의 목록이 포함되어야 한다.
spec:
  selector:
    app: sleep-2   # app 레이블의 값이 sleep-2인 모든 파드가 대상이다.
  ports:
    - port: 80   # 80번 포트를 주시하다가 파드의 80번 포트로 트래픽을 전달한다.
```

Cmd **서비스를 통한 파드 간 통신 - 실패**
*ref.* [[쿠버네티스-Ch1.pdf#page=84]]


# 파드와 파드 간 통신

## 서비스 :: 클러스터 IP 
> + 서비스의 가장 기본이 되는 유형
> + 클러스터 내에서 유효한 IP이다.
> + 파드가 어떤 노드에 있더라도 접근 가능

**1) 문제 상황**
> + 두 개의 디플로이먼트 실행
> + 하지만, 서비스가 없으므로 통신 불가능

*ref.* [[쿠버네티스-Ch1.pdf#page=86]]

**1) 해결**
> + 서비스 등록
>```
>apiVersion: v1
>kind: Service
>
>metadata:
>  name: numbers-api  # 서비스의 이름이 도메인 네임 으로 활용된다.
>  
>spec:
>  ports:
 >   - port: 80
>  selector:
 >   app: numbers-api
 >  type: ClusterIP   # 기본 값 이긴하나, 명확성을 위해 명시
>```
>
>웹 애플리케이션은 도메인 네임을 통해 접속한다.
>`http://numbers-api/...`

*ref.* [[쿠버네티스-Ch1.pdf#page=90]]


# 외부 트래픽을 파드로 전달하기

## 서비스 :: 로드밸런서

**로드밸런서**
> + 외부 트래픽을  파드에 전달
> + 파드가 어느 노드에 있던지 상관없이 전달 가능 (**전체 클러스터 커버**) 
> 	+ 레이블 셀렉터 이용
> + 외부 로드밸런서 필요

![[로드밸런서 서비스.png]]
Cmd **로드밸런서 매니페스트 설정**
*ref.* [[쿠버네티스-Ch1.pdf#page=92]]
```
apiVersion: v1
kind: Service

metadata:
  name: numbers-web

spec:
  ports:
    - port: 8080  # 서비스가 주시하는 포트
      targetPort: 80  # 트래픽이 전달될 파드의 포트
  selector:
    app: numbers-web
  type: LoadBalancer
```

**내 이해**
>+ 서비스 :: 고정 IP를 가지고 트래픽을 받아 파드에 전달해준다.
>+ 로드밸런스 서비스
>	+ 외부 트래픽을 받아서 연결된 파드에 전달
>	+ 클러스터IP도 부여되므로, 내부 트래픽도 전달 가능

*ref.* [[쿠버네티스-Ch1.pdf#page=93]]

## 서비스 :: 노드포트
*ref.* [[쿠버네티스-Ch1.pdf#page=95]]
> 잘 사용되지 않는다.


# 쿠버네티스 클러스터 외부로 트래픽 전달

**필요성**
> 보통 데이터베이스는 쿠버네티스 외부에서 동작시키도록 한다.
> 그러면, 클러스터 외부에 요청을 할 수 있어야 한다.
## 방법 #1 - 익스터널 네임 서비스

**특징**
> + 외부 도메인에 대한 별명
> + 내부에서는 별명을 사용하고, DNS 서버에 별명을 통해 외부 도메인 조회
```
apiVersion: v1
kind: Service

metadata:
  name: numbers-api  ## 클러스터 안에서 쓰이는 로컬 도메인 네임 (별명)
  
spec:
  type: ExternalName
  externalName: raw.githubusercontent.com  ## 외부 도메인
```
*ref.* [[쿠버네티스-Ch1.pdf#page=97]]

**한계**
> 별명 → 외부 도메인 치환 역할만 한다. 
> 즉,  HTTP 요청 시, 요청 헤더에 외부 도메인이 들어가야 하므로 수동으로 별명을 외부 도메인으로 변경해야 한다.


## 방법#2 - 헤드리스 서비스

**배경**
> 별명을 외부 도메인으로 단순 치환이 외부 도메인으로 연결 필요

**내 이해**
> + 클러스터 IP (내부 가상 IP) 타입인데, 연결된 파드가 없이 엔드포인트 목록으로 전송
> + 기존 클러스터 IP :: 클러스터 IP로 전송 시 연결된 파드로 전송
> + 헤드리스 서비스 :: 클러스터 IP로 전송 시 연결된 엔드포인트(외부 도메인)로 전송


# 쿠버네티스 네임스페이스

*ref.* [[쿠버네티스-Ch1.pdf#page=106]]
